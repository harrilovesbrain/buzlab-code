function hs_MUA_simple(basepath)
%% ================================================================
%  hs_MUA_simple(basepath)
%  Purpose: Extract MUA envelope (500â€“5000 Hz band)
%           from a .dat file using sessionInfo + bz_LoadBinary.
%           FAST version â€“ LEC only â€“ with progress bar.
%
%  Created by Husang Harry Lee
% ================================================================

if nargin < 1 || ~isfolder(basepath)
    error('Basepath not provided or invalid.');
end

fprintf('\nðŸ“‚ Processing folder: %s\n', basepath);

%% -----------------------------------------------------------------
% 1ï¸âƒ£ Load session information
% ------------------------------------------------------------------
sessionInfoFile = dir(fullfile(basepath, '*.sessionInfo.mat'));
if isempty(sessionInfoFile)
    error('sessionInfo.mat not found in %s', basepath);
end
load(fullfile(basepath, sessionInfoFile(1).name), 'sessionInfo');

% Find .dat file
datFile = dir(fullfile(basepath, '*.dat'));
if isempty(datFile)
    error('No .dat file found in %s', basepath);
end
fileDat = fullfile(basepath, datFile(1).name);

%% Sampling rates
if isfield(sessionInfo, 'rates') && isfield(sessionInfo.rates, 'wideband')
    fs = sessionInfo.rates.wideband;
elseif isfield(sessionInfo, 'session') && isfield(sessionInfo.session, 'SampleRate')
    fs = sessionInfo.session.SampleRate;
else
    error('Sampling rate not found in sessionInfo.');
end

%% -----------------------------------------------------------------
% 2ï¸âƒ£ Use only LEC channels 128â€“255 (0-indexed)
% ------------------------------------------------------------------
lecChannels = 128:255;
nChannels   = sessionInfo.nChannels;
targetFs    = sessionInfo.lfpSampleRate;
dsFactor    = round(fs / targetFs);

fprintf('âœ” LEC channels: 128â€“255  (%d channels)\n', numel(lecChannels));
fprintf('âœ” fs = %.0f Hz â†’ %.0f Hz\n', fs, targetFs);

%% -----------------------------------------------------------------
% 3ï¸âƒ£ Design band-pass filter
% ------------------------------------------------------------------
lowCut  = 500;
highCut = 5000;
order   = 3;
[b,a]   = butter(order, [lowCut highCut] / (fs/2), 'bandpass');

%% -----------------------------------------------------------------
% 4ï¸âƒ£ Process each LEC channel (FAST) with progress bar
% ------------------------------------------------------------------
nCh = numel(lecChannels);
mua_cell = cell(nCh,1);

h = waitbar(0, 'Extracting MUA (LEC channels 128â€“255)...');

for k = 1:nCh
    ch = lecChannels(k);

    % Load one channel from .dat
    raw = bz_LoadBinary(fileDat, ...
        'channels', ch + 1, ...    % convert 0â†’1 indexing
        'nChannels', nChannels, ...
        'precision', 'int16');

    % 1. Filter
    sig_bp = filtfilt(b, a, double(raw));

    % 2. Rectify
    sig_rect = abs(sig_bp);

    % 3. Smooth (~2 ms window)
    win = round(fs * 0.002);
    sig_env = smoothdata(sig_rect, 'gaussian', win);

    % 4. Downsample
    sig_env_ds = downsample(sig_env, dsFactor);

    mua_cell{k} = single(sig_env_ds);

    waitbar(k/nCh, h, sprintf('Processing channel %d / %d', ch, lecChannels(end)));
end
close(h);

%% -----------------------------------------------------------------
% 5ï¸âƒ£ Combine & save MUA
% ------------------------------------------------------------------
minLen = min(cellfun(@numel, mua_cell));
MUA.data = zeros(minLen, nCh, 'single');
for k = 1:nCh
    MUA.data(:,k) = mua_cell{k}(1:minLen);
end

MUA.fs       = targetFs;
MUA.band     = [lowCut highCut];
MUA.channels = lecChannels;

outFile = fullfile(basepath, [sessionInfo.FileName '.MUA.mat']);
save(outFile, 'MUA', '-v7.3');

fprintf('âœ… Saved %s\n', outFile);

%% -----------------------------------------------------------------
% 6ï¸âƒ£ Optional plot
% ------------------------------------------------------------------
if usejava('desktop')
    figure('Name','LEC MUA Envelope','Color','w');
    imagesc(zscore(MUA.data,[],1)'); axis xy;
    xlabel('Time (samples)'); 
    ylabel('LEC channels (128â†’255)');
    title(sprintf('MUA Envelope (%dâ€“%d Hz, LEC only)', lowCut, highCut));
    colormap jet;
    colorbar;
end
end
