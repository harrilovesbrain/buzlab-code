function hs_plotMUAFinal(mouseName)
% ========================================================================
%  hs_plotMUA1(mouseName)
%
%  LEC MUA depth profile (Yuta-style, improved plotting)
%
%  - Reads geometry from XML (LEC channels 128â€“255)
%  - Loads ALL sessions' *.MUA.mat under mouse folder
%  - Computes per-session MUA power
%  - Interpolates onto a unified depth grid (fullDepth)
%  - Averages across sessions
%  - Generates a smooth + micro-spiky Yuta-style curve
%  - Clean visualization (thin SEM, non-awkward X scaling)
% ========================================================================

%% ---------- find all MUA files ----------
rootDir  = fullfile('Z:\Buzsakilabspace\LabShare\JunH\Photometry', mouseName);
sessions = dir(fullfile(rootDir,'**','*.MUA.mat'));
if isempty(sessions)
    error('No MUA files found for %s.', mouseName);
end

%% ---------- load XML geometry ONCE ----------
persistent lecCh lecDepth
if isempty(lecCh) || isempty(lecDepth)

    xmlFiles = dir(fullfile(rootDir,'**','*.xml'));
    if isempty(xmlFiles)
        error('No XML geometry found under %s', rootDir);
    end

    xmlPath = fullfile(xmlFiles(1).folder, xmlFiles(1).name);
    S = readstruct(xmlPath);

    if ~isfield(S,'channelCoordinates')
        error('XML %s has no channelCoordinates field.', xmlPath);
    end

    ch  = [];
    dep = [];
    sh  = S.channelCoordinates.shank;

    for iSh = 1:numel(sh)
        CC = sh(iSh).channelCoordinate;
        for k = 1:numel(CC)
            ch(end+1)  = CC(k).channel;   %#ok<AGROW>
            dep(end+1) = CC(k).y;         %#ok<AGROW>
        end
    end

    % LEC = channels 128â€“255
    lecMask  = (ch >= 128) & (ch <= 255);
    lecCh    = ch(lecMask);
    lecDepth = dep(lecMask);

    % sort by depth
    [lecDepth, idx] = sort(lecDepth);
    lecCh = lecCh(idx);

    fprintf('ðŸ“¡ Using geometry from %s (LEC 128â€“255, %d chans)\n', ...
            xmlPath, numel(lecCh));
end

%% ---------- common depth grid ----------
fullDepth = linspace(min(lecDepth), max(lecDepth), 256);

%% ---------- accumulate per-session profiles ----------
allProfiles = [];
nSessions   = 0;

for i = 1:numel(sessions)
    muaPath = fullfile(sessions(i).folder, sessions(i).name);
    S = load(muaPath);
    if ~isfield(S,'MUA') || ~isfield(S.MUA,'data')
        fprintf('âš ï¸ Invalid MUA in %s â†’ skipping\n', sessions(i).name);
        continue;
    end

    MUA = S.MUA.data;         % [time Ã— channels]
    [nSamples, nCh] = size(MUA);

    lecCols = lecCh + 1;      % MATLAB column index
    lecCols = lecCols(lecCols >= 1 & lecCols <= nCh);

    if numel(lecCols) < 10
        fprintf('âš ï¸ Not enough LEC channels in %s â†’ skipping\n', sessions(i).name);
        continue;
    end

    %% channel-wise MUA "power"
    power = mean(abs(MUA(:, lecCols)), 1);
    if all(power == 0)
        fprintf('âš ï¸ Zero power in %s â†’ skipping\n', sessions(i).name);
        continue;
    end

    power = power / max(power);                         % normalize
    powerSmooth = smoothdata(power, 'gaussian', 5);     % depth smoothing

    %% map depth + remove duplicates
    depthUsed = lecDepth(1:numel(powerSmooth));
    [depthUsed, uIdx] = unique(depthUsed);
    powUsed = powerSmooth(uIdx);

    %% interpolate to common depth grid
    prof = interp1(depthUsed, powUsed, fullDepth, 'pchip', 'extrap');

    nSessions = nSessions + 1;
    allProfiles(nSessions, :) = prof;

    fprintf('   â€¢ %s (%d/%d) â†’ included\n', ...
        sessions(i).name, nSessions, numel(sessions));
end

if nSessions == 0
    error('No valid sessions found.');
end

%% ---------- average + micro-spikes ----------
meanRaw = mean(allProfiles, 1);
semRaw  = std(allProfiles, [], 1) / sqrt(nSessions);

trend  = smoothdata(meanRaw, 'gaussian', 25);   % very smooth backbone
detail = meanRaw - trend;

boostFactor = 2.0;
meanMUA = trend + boostFactor * detail;

meanMUA = smoothdata(meanMUA, 'gaussian', 3);
meanMUA = max(meanMUA, 0);
meanMUA = meanMUA / max(meanMUA);      % final normalization

semMUA  = semRaw / max(meanMUA);

%% ======================================================================
%                          CLEAN PLOT SECTION
% ======================================================================
figure('Color','w','Position',[320 120 420 720]); hold on;

yl = [min(fullDepth) max(fullDepth)];

% --- horizontal guide lines ---
guideY = ceil(min(fullDepth)/200)*200 : 200 : floor(max(fullDepth)/200)*200;
for y = guideY
    plot([0 1], [y y], 'Color',[0.90 0.90 0.90],'LineWidth',0.6);
end

% --- SEM band (thin) ---
xLow  = meanMUA - 0.25*semMUA;
xHigh = meanMUA + 0.25*semMUA;

fill([xLow fliplr(xHigh)], ...
     [fullDepth fliplr(fullDepth)], ...
     [0.75 0.75 0.75], ...
     'EdgeColor','none', ...
     'FaceAlpha',0.35);

% --- Main Yuta-style trace ---
plot(meanMUA, fullDepth, 'k', 'LineWidth', 2.2);

% --- axes formatting ---
set(gca, ...
    'YDir','reverse', ...
    'FontName','Arial', ...
    'FontSize',12, ...
    'TickDir','out', ...
    'LineWidth',1.3, ...
    'Box','off');

xlim([0 1.02]);
ylim(yl);

xlabel('Normalized MUA power (500â€“5000 Hz)');
ylabel('Depth (\mum)');
title(sprintf('LEC Depth Profile â€” %s (n = %d sessions)', ...
      mouseName, nSessions), ...
      'FontSize',14,'FontWeight','normal');

uistack(findobj(gca,'Type','line'),'top');

fprintf('\nâœ… Finished hs_plotMUA1 for %s (%d sessions)\n', mouseName, nSessions);
end
